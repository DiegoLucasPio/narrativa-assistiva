<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Narrativa Assistiva - Estável</title>
    <style>
        body { font-family: sans-serif; background: #f8f9fa; text-align: center; padding: 20px; }
        #statusVoz { font-weight: bold; padding: 15px; margin: 10px; border-radius: 10px; background: white; border: 2px solid #007bff; display: inline-block; }
        .instrucoes { color: #666; font-size: 0.9rem; margin-top: 10px; }
        textarea { width: 90%; height: 200px; font-size: 1.4rem; padding: 15px; margin-top: 20px; border: 3px solid #007bff; border-radius: 8px; }
        .quadros { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .cena { width: 200px; background: white; border: 1px solid #ccc; padding: 5px; border-radius: 8px; }
        .cena img { width: 100%; height: 120px; object-fit: cover; }
    </style>
</head>
<body>

    <button id="btnStart" style="padding: 15px 30px; font-size: 1.2rem; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px;">ATIVAR SISTEMA</button>
    <br>
    <div id="statusVoz">Aguardando ativação...</div>

    <div class="quadros">
        <div class="cena"><img src="https://picsum.photos/seed/f1/300/200"><div>Cena 1</div></div>
        <div class="cena"><img src="https://picsum.photos/seed/f2/300/200"><div>Cena 2</div></div>
        <div class="cena"><img src="https://picsum.photos/seed/f3/300/200"><div>Cena 3</div></div>
    </div>

    <textarea id="campo" placeholder="Escreva sua história aqui..."></textarea>

    <div class="instrucoes">Comandos: Descrever, Leitura, Sinônimo, Salvar.</div>

    <script>
        const status = document.getElementById('statusVoz');
        const campo = document.getElementById('campo');
        const btn = document.getElementById('btnStart');
        const synth = window.speechSynthesis;

        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new Recognition();
        rec.lang = 'pt-BR';
        rec.continuous = false; // "false" evita o erro 'aborted' em muitas redes

        function falar(t) {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'pt-BR';
            synth.speak(u);
        }

        btn.onclick = () => {
            btn.style.background = "#28a745";
            btn.innerText = "SISTEMA ATIVO";
            falar("Sistema iniciado.");
            try { rec.start(); } catch(e) {}
        };

        rec.onstart = () => { status.innerText = "OUVINDO..."; };
        
        rec.onresult = (event) => {
            const fala = event.results[0][0].transcript.toLowerCase();
            status.innerText = "OUVI: " + fala;
            
            if (fala.includes("descrever")) {
                falar("Cena 1: Floresta azul. Cena 2: Baú antigo. Cena 3: Menino sorrindo.");
            } else if (fala.includes("leitura")) {
                falar(campo.value || "Nada escrito.");
            } else if (fala.includes("sinônimo")) {
                const p = campo.value.trim().split(/\s+/);
                const u = p[p.length-1].toLowerCase().replace(/[.,!]/g, "");
                const db = {"feliz": ["alegre", "contente"], "olhar": ["ver", "observar"]};
                falar(db[u] ? `Sinônimos de ${u}: ${db[u].join(", ")}` : "Não encontrei sinônimos.");
            } else if (fala.includes("salvar")) {
                const blob = new Blob([campo.value], {type: 'text/plain'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'historia.txt';
                a.click();
                falar("História salva.");
            }
        };

        // Reinício automático sem causar o erro 'aborted'
        rec.onend = () => {
            if (btn.innerText === "SISTEMA ATIVO") {
                setTimeout(() => { try { rec.start(); } catch(e) {} }, 100);
            }
        };

        rec.onerror = (e) => {
            console.log("Erro: " + e.error);
            if (e.error === 'aborted') status.innerText = "Reconectando microfone...";
        };
    </script>
</body>
</html>
