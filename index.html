<!DOCTYPE html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Diagn칩stico de Voz</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        #status { font-weight: bold; font-size: 1.2rem; color: #007bff; margin-bottom: 10px; }
        #medidor { width: 300px; height: 20px; background: #ddd; margin: 10px auto; border-radius: 10px; overflow: hidden; }
        #barra { width: 0%; height: 100%; background: #28a745; transition: width 0.1s; }
        textarea { width: 80%; height: 100px; margin-top: 20px; }
        .log { font-family: monospace; font-size: 0.8rem; color: #666; background: #eee; padding: 10px; margin-top: 20px; text-align: left; }
    </style>
</head>
<body>

    <h2>Diagn칩stico de Sistema</h2>
    <button id="btn" style="padding: 15px 30px; font-size: 1.2rem;">ATIVAR SISTEMA</button>
    
    <div id="status">Aguardando...</div>
    
    <p>Volume do Microfone:</p>
    <div id="medidor"><div id="barra"></div></div>

    <textarea id="campo" placeholder="Texto aparecer치 aqui..."></textarea>
    
    <div id="debug" class="log">Log de eventos:</div>

    <script>
        const btn = document.getElementById('btn');
        const barra = document.getElementById('barra');
        const debug = document.getElementById('debug');
        const status = document.getElementById('status');
        const campo = document.getElementById('campo');

        function addLog(msg) {
            debug.innerHTML += "<br>> " + msg;
            console.log(msg);
        }

        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new Recognition();
        rec.lang = 'pt-BR';
        rec.continuous = true;
        rec.interimResults = true;

        btn.onclick = async () => {
            addLog("Iniciando microfone...");
            rec.start();
            
            // Ativa medidor de volume real para testar hardware
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = () => {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;
                    for (let i = 0; i < array.length; i++) values += array[i];
                    const average = values / array.length;
                    barra.style.width = Math.min(average * 2, 100) + "%";
                };
                addLog("Hardware de 치udio detectado com sucesso.");
            } catch (err) {
                addLog("ERRO DE HARDWARE: " + err.message);
            }
        };

        rec.onresult = (event) => {
            const fala = event.results[event.results.length - 1][0].transcript;
            status.innerText = "OUVI: " + fala;
            addLog("Texto detectado: " + fala);
            if(fala.toLowerCase().includes("leitura")) {
                window.speechSynthesis.speak(new SpeechSynthesisUtterance("Lendo seu texto"));
            }
        };

        rec.onerror = (e) => addLog("Erro de Reconhecimento: " + e.error);
        rec.onend = () => {
            addLog("Reiniciando escuta...");
            rec.start();
        };
    </script>
</body>
</html>
